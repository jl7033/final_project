---
title: "Preliminary analysis"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(rvest)
library(readxl)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%",
  dpi = 300
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```


#### Salaries Dataset

Descrition of data cleaning: 

-   reading in data

-   selecting and renaming the columns

-   since names are in last, first format, reorder them to be first last

-   make sure all "Jr"s go at the end

-   remove accents using stringi::stri_trans_general

```{r}
salaries = read_excel(
  "data/MLB-Salaries 2000-24.xlsx", 
  sheet = "2022.xls",
  skip = 1) |>
  select(1:4) |>
  rename(position = "Pos'n",
         salary_2022 = "2022.0",
         service_time_yrs = "MLS",
         name = "Player") %>%
  mutate(name = str_split(name, ","),
         name = map(name, rev),       
         name = map_chr(name, str_c, collapse = " "),
         name = str_trim(name),
         name = str_replace_all(name, "[*#\\.,]", ""),
         junior = str_detect(name, "Jr"),
         name = if_else(junior == TRUE, str_remove(name, " Jr"), name),
         name = if_else(junior == TRUE, str_c(name, " Jr"), name),
         name = stringi::stri_trans_general(name,id = "Latin-ASCII")) |>
  select(-junior)
```

#### Batting and Pitching Datasets

Descrition of data cleaning: 

-   reading in data and clean names

-   grouping by name and using a count to ensure we only end up with one of each name (slightly complicated due to interleague trades and potential for players with the same name)

-  remove whitespace, from names and use stringi again to remove accents so that the formatting exactly matches the salaries tibble

```{r}
batting = read_delim("data/2022 MLB Player Stats - Batting.csv", delim = ";",
                     locale = locale(encoding = "latin1")) |>
  janitor::clean_names() %>%
  group_by(name) |>
  mutate(name_count = n(),
         keep_row = case_when(name_count == 1 ~ TRUE,
                              name_count > 1 & tm == "TOT" ~ TRUE,
                              .default = FALSE)) |>
  filter(keep_row == TRUE) %>%
  mutate(name_count = n(),
         keep_row = case_when(name_count == 1 ~ TRUE,
                              name_count > 1 & lg == "MLB" ~ TRUE,
                              .default = FALSE)) |>
  ungroup() |>
  filter(keep_row == TRUE) %>%
  mutate(name = str_split(name, "\\s+"),
         name = map_chr(name, str_c, collapse = " "),
         name = str_trim(name),
         name = str_replace_all(name, "[*#\\.]", ""),
         name = stringi::stri_trans_general(name,id = "Latin-ASCII"))

merged_batting <- inner_join(salaries, batting, by = "name")

salary_not_in_batting <- anti_join(salaries, batting, by = "name")
batting_not_in_salary <- anti_join(batting, salaries, by = "name")
```

(same data cleaning process as above)
```{r}
pitching = read_delim("data/2022 MLB Player Stats - Pitching.csv", delim = ";",
                     locale = locale(encoding = "latin1")) |>
  janitor::clean_names() %>%
  group_by(name) |>
  mutate(name_count = n(),
         keep_row = case_when(name_count == 1 ~ TRUE,
                              name_count > 1 & tm == "TOT" ~ TRUE,
                              .default = FALSE)) |>
  filter(keep_row == TRUE) %>%
  mutate(name_count = n(),
         keep_row = case_when(name_count == 1 ~ TRUE,
                              name_count > 1 & lg == "MLB" ~ TRUE,
                              .default = FALSE)) |>
  ungroup() |>
  filter(keep_row == TRUE) %>%
  mutate(name = str_split(name, "\\s+"),
         name = map_chr(name, str_c, collapse = " "),
         name = str_trim(name),
         name = str_replace_all(name, "[*#\\.]", ""),
         name = stringi::stri_trans_general(name,id = "Latin-ASCII"))

merged_pitching <- inner_join(salaries, pitching, by = "name")

salary_not_in_pitching <- anti_join(salaries, pitching, by = "name")
pitching_not_in_salary <- anti_join(pitching, salaries, by = "name")
```

Note that there are a number of names in `salaries` not found in `batting` or `pitching`, and vice versa. Some of this may be genuine missingness (e.g. salaries has fewer rows than pitching and batting combined), but some is also due to alternative spellings of names in the datasets. Possibly could be fixed using other matching methods, but the analysis pipeline will still work from here.


## Batting EDA

Start with some descriptive statistics/plots
```{r}
merged_batting |>
  ggplot(aes(x = service_time_yrs)) + 
  geom_density()
```

```{r}
merged_batting |>
  ggplot(aes(x = salary_2022)) + 
  geom_density()
```

Position type (note that some players are categorized at multiple positions)
```{r}
merged_batting |>
  mutate(positions = case_when(str_detect(position, "rhp") ~ list("rhp"),
                               str_detect(position, "lhp") ~ list("lhp"),
                               .default = str_split(position, "-")))  |>
  unnest(positions) |>
  count(positions) |> 
  arrange(-n)
```



Looking at some hitting statistics
```{r}
merged_batting |> 
  ggplot(aes(x = hr)) + 
  geom_histogram()

merged_batting |> 
  ggplot(aes(x = rbi)) + 
  geom_histogram()

merged_batting |> 
  ggplot(aes(x = ops)) + 
  geom_histogram()

merged_batting |> 
  ggplot(aes(x = ops_2)) + 
  geom_histogram()
```

Looking at some relationships to salary

Position vs. salary
```{r}
merged_batting |>
  mutate(positions = case_when(str_detect(position, "rhp") ~ list("rhp"),
                               str_detect(position, "lhp") ~ list("lhp"),
                               .default = str_split(position, "-")))  |>
  unnest(positions) |>
  ggplot(aes(x = positions,y= salary_2022)) +
  geom_boxplot()

merged_batting |>
  mutate(positions = case_when(str_detect(position, "rhp") ~ list("rhp"),
                               str_detect(position, "lhp") ~ list("lhp"),
                               .default = str_split(position, "-")))  |>
  unnest(positions) |>
  group_by(positions) |>
  summarize(avg_salary = mean(salary_2022, na.rm = TRUE),
            median_salary = median(salary_2022, na.rm = TRUE))
```

HR vs. salary
```{r}
merged_batting |>
  ggplot(aes(x = hr, y = salary_2022)) + 
  geom_point()
```

OPS+ vs salary
```{r}
merged_batting |>
  ggplot(aes(x = ops_2, y = salary_2022)) + 
  geom_point()
```


## Pitching EDA
## Salaries EDA

Some Basic EDA for salaries on their own
```{r}

salaries_position_split = salaries %>%
  mutate(simple_position = str_split_i(position, "-", 1))

# Salaries by Position Boxplots

salaries_position_split %>% 
  ggplot(aes(x=simple_position,y=salary_2022)) +
  geom_boxplot()

# Salaries by Experience 

salaries_position_split %>%
  ggplot(aes(x=floor(service_time_yrs),y=salary_2022)) +
  geom_col() 

# Positions by Experience

salaries_position_split %>%
  ggplot(aes(x=floor(service_time_yrs),fill = simple_position)) +
  geom_bar(position = "fill") 

# Salary Distribution by Experience

salaries_position_split %>%
  ggplot(aes(x=factor(floor(service_time_yrs)), y=salary_2022)) +
  geom_boxplot()

```

